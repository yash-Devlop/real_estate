{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ apartment.property_name }} - Apartelle</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> {# Added Font Awesome for icons #}
    <style>
        /* Your existing CSS (from the provided snippet) starts here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafafa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Section */
        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: #FF6B35;
        }

        .back-btn {
            background: #FF6B35;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }

        /* Main Content Grid */
        .property-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        /* Image Gallery Section */
        .image-gallery {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .main-image-container {
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
            border-radius: 12px;
        }

        .main-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .main-image:hover {
            transform: scale(1.02);
        }

        .image-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 107, 53, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Thumbnail Gallery */
        .thumbnail-gallery {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .thumbnail-gallery::-webkit-scrollbar {
            height: 6px;
        }

        .thumbnail-gallery::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .thumbnail-gallery::-webkit-scrollbar-thumb {
            background: #FF6B35;
            border-radius: 3px;
        }

        .thumbnail {
            min-width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .thumbnail:hover {
            border-color: #FF6B35;
            transform: translateY(-2px);
        }

        .thumbnail.active {
            border-color: #FF6B35;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        /* Property Details Section */
        .property-details {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .property-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .property-price {
            font-size: 32px;
            font-weight: 700;
            color: #FF6B35;
            margin-bottom: 25px;
        }

        .property-location {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Property Features Grid */
        .features-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .feature-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #FF6B35;
        }

        .feature-value {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            display: block;
        }

        .feature-label {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Additional Info */
        .additional-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #495057;
        }

        .info-value {
            font-weight: 600;
            color: #2c3e50;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .btn-primary {
            flex: 1;
            background: #FF6B35;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: block;
        }

        .btn-primary:hover {
            background: #e55a2b;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
        }

        .btn-secondary {
            flex: 1;
            background: transparent;
            color: #FF6B35;
            padding: 15px 20px;
            border: 2px solid #FF6B35;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: block;
        }

        .btn-secondary:hover {
            background: #FF6B35;
            color: white;
            transform: translateY(-2px);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-sold {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .property-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .property-title {
                font-size: 24px;
            }

            .property-price {
                font-size: 28px;
            }

            .main-image {
                height: 300px;
            }

            .container {
                padding: 15px;
            }
        }

        /* Loading Animation */
        .image-loading {
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        /* Hover Effects */
        .property-details:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .image-gallery:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        /* Custom Styles for Schedule Visit Form */
        .schedule-visit-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 30px; /* Space from property details */
        }

        .schedule-visit-card h3 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .schedule-visit-card .form-group {
            margin-bottom: 20px;
        }

        .schedule-visit-card label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .schedule-visit-card input[type="date"],
        .schedule-visit-card input[type="time"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.2s ease;
            -webkit-appearance: none; /* Remove default styling on some browsers */
            -moz-appearance: none;
            appearance: none;
        }

        .schedule-visit-card input[type="date"]:focus,
        .schedule-visit-card input[type="time"]:focus {
            border-color: #FF6B35;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        .schedule-visit-card input[type="date"][disabled],
        .schedule-visit-card input[type="time"][disabled] {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .schedule-visit-card .btn-schedule {
            background: #FF6B35;
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .schedule-visit-card .btn-schedule:hover {
            background: #e55a2b;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
        }

        .schedule-visit-card .btn-schedule[disabled] {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }
        
        .message-box {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 15px;
            text-align: center;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .login-prompt {
            text-align: center;
            margin-top: 15px;
            color: #7f8c8d;
            font-size: 15px;
        }
        .login-prompt a {
            color: #FF6B35;
            font-weight: 600;
            text-decoration: none;
        }
        .login-prompt a:hover {
            text-decoration: underline;
        }

        /* Spinner for button */
        .spinner {
            display: none; /* Hidden by default */
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">Apartelle</div>
            <a href="{% url 'index' %}" class="back-btn">← Back to Properties</a> {# Changed to properties as it's more general #}
        </div>
    </div>

    <div class="container">
        <div class="property-content">
            <!-- Image Gallery Section -->
            <div class="image-gallery">
                <div class="main-image-container">
                    <img id="mainDisplayImage" class="main-image" src="{{ apartment.main_image.url }}" alt="{{ apartment.property_name }}">
                    <div class="image-overlay">Featured</div>
                </div>
                
                <div class="thumbnail-gallery">
                    <!-- Main image thumbnail -->
                    <img src="{{ apartment.main_image.url }}" 
                            alt="Main Image" 
                            class="thumbnail active" 
                            onclick="switchMainImage(this.src, this)">
                    
                    <!-- Brochure images -->
                    {% for b in brochures %}
                        <img src="{{ b.image.url }}" 
                                alt="Property Image {{ forloop.counter }}" 
                                class="thumbnail" 
                                onclick="switchMainImage(this.src, this)">
                    {% endfor %}
                </div>
            </div>

            <!-- Property Details Section -->
            <div class="property-details">
                <div class="status-badge status-{{ apartment.status|lower }}">
                    {{ apartment.status }}
                </div>
                
                <h1 class="property-title">{{ apartment.property_name }}</h1>
                <div class="property-price">${{ apartment.price }}</div>
                <div class="property-location">
                    📍 {{ apartment.address }}, {{ apartment.city }}
                </div>

                <!-- Key Features -->
                <div class="features-grid">
                    <div class="feature-item">
                        <span class="feature-value">{{ apartment.bedrooms }}</span>
                        <span class="feature-label">Bedrooms</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-value">{{ apartment.bathrooms }}</span>
                        <span class="feature-label">Bathrooms</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-value">{{ apartment.area }}</span>
                        <span class="feature-label">Area</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-value">{{ apartment.parking }}</span>
                        <span class="feature-label">Parking</span>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="additional-info">
                    <div class="info-row">
                        <span class="info-label">Property Type</span>
                        <span class="info-value">{{ apartment.type }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Floor</span>
                        <span class="info-value">{{ apartment.floor }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value">{{ apartment.status }}</span>
                    </div>
                </div>

                {# Moved action buttons to below the scheduler or integrated into it #}
                {# Existing action-buttons div removed or repurposed #}
            </div>
            
        </div>

        <!-- NEW: Schedule Visit Card -->
        <div class="schedule-visit-card">
            <h3>Schedule a Visit</h3>
            
            <div id="scheduleMessageBox" class="message-box"></div>

            <form id="scheduleVisitForm">
                {% csrf_token %}
                <input type="hidden" id="apartmentId" value="{{ apartment.property_id }}">
                <input type="hidden" id="userId" value="{{ user_id }}">

                <div class="form-group">
                    <label for="visitDate"><i class="far fa-calendar-alt"></i> Select Date:</label>
                    <input type="date" id="visitDate" name="visitDate" required 
                           min="{{ min_date_str }}" {% if not is_logged_in %}disabled{% endif %}>
                </div>
                
                <div class="form-group">
                    <label for="visitTime"><i class="far fa-clock"></i> Select Time:</label>
                    <input type="time" id="visitTime" name="visitTime" required 
                           {% if not is_logged_in %}disabled{% endif %}>
                </div>

                <button type="submit" class="btn-schedule" id="scheduleBtn" {% if not is_logged_in %}disabled{% endif %}>
                    Schedule Now
                    <span class="spinner"></span>
                </button>
            </form>

            {% if not is_logged_in %}
                <p class="login-prompt">Please <a href="{% url 'user_login' %}" target="__blank">login</a> to schedule a visit.</p>
            {% endif %}
        </div>
    </div>

    <script>
        function switchMainImage(src, clickedThumbnail) {
            const mainImage = document.getElementById("mainDisplayImage");
            mainImage.classList.add('image-loading');
            
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            
            clickedThumbnail.classList.add('active');
            
            setTimeout(() => {
                mainImage.src = src;
                mainImage.classList.remove('image-loading');
            }, 150);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                img.addEventListener('load', function() {
                    this.style.opacity = '1';
                });
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    const thumbnails = document.querySelectorAll('.thumbnail');
                    const activeThumbnail = document.querySelector('.thumbnail.active');
                    const currentIndex = Array.from(thumbnails).indexOf(activeThumbnail);
                    
                    let newIndex;
                    if (e.key === 'ArrowRight') {
                        newIndex = (currentIndex + 1) % thumbnails.length;
                    } else {
                        newIndex = (currentIndex - 1 + thumbnails.length) % thumbnails.length;
                    }
                    
                    thumbnails[newIndex].click();
                }
            });

            // --- Schedule Visit Form Logic ---
            const scheduleVisitForm = document.getElementById('scheduleVisitForm');
            const visitDateInput = document.getElementById('visitDate');
            const visitTimeInput = document.getElementById('visitTime');
            const scheduleBtn = document.getElementById('scheduleBtn');
            const apartmentId = document.getElementById('apartmentId').value;
            const userId = document.getElementById('userId').value;
            const scheduleMessageBox = document.getElementById('scheduleMessageBox');
            const spinner = scheduleBtn.querySelector('.spinner');

            // Set minimum date for the date picker (today)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            visitDateInput.min = `${year}-${month}-${day}`;

            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');


            function showScheduleMessage(type, message) {
                scheduleMessageBox.className = `message-box ${type}`;
                scheduleMessageBox.textContent = message;
                scheduleMessageBox.style.display = 'block';
                setTimeout(() => {
                    scheduleMessageBox.style.display = 'none';
                }, 5000);
            }

            scheduleVisitForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                // Basic client-side validation
                if (!visitDateInput.value || !visitTimeInput.value) {
                    showScheduleMessage('error', 'Please select both date and time for your visit.');
                    return;
                }

                if (!userId || userId === 'None') { // Check if user_id is properly set (i.e., user is logged in)
                    showScheduleMessage('error', 'You must be logged in to schedule a visit. Please log in first.');
                    return;
                }

                // Combine date and time into a single datetime string (ISO 8601 format)
                // Append 'Z' for UTC if your server expects UTC, otherwise adjust timezone.
                // For simplicity, let's assume server handles timezone, just send combined local datetime.
                const visitDateTimeLocal = `${visitDateInput.value}T${visitTimeInput.value}:00`; // YYYY-MM-DDTHH:MM:SS
                
                // For visit_date_str, format nicely for human-readable string
                const selectedDate = new Date(`${visitDateInput.value}T${visitTimeInput.value}`);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };
                const visitDateStr = selectedDate.toLocaleString('en-US', options);


                scheduleBtn.disabled = true;
                spinner.style.display = 'inline-block'; // Show spinner

                try {
                    const response = await fetch('/api/schedule_visit/', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({
                            apartment_id: apartmentId,
                            user_id: userId,
                            visit_datetime: visitDateTimeLocal,
                            visit_date_str: visitDateStr
                        })
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        showScheduleMessage('success', data.message);
                        scheduleVisitForm.reset(); // Clear the form
                    } else {
                        showScheduleMessage('error', data.message);
                    }
                } catch (error) {
                    console.error('Error scheduling visit:', error);
                    showScheduleMessage('error', 'An error occurred while scheduling your visit. Please try again.');
                } finally {
                    scheduleBtn.disabled = false;
                    spinner.style.display = 'none'; // Hide spinner
                }
            });
        });
    </script>
</body>
</html>
